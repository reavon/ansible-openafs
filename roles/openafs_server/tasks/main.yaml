---

# TODO: REMOVE THIS
# Soften the system until I sort out the selinux labeling.
- name: disable selinux
  selinux:
    state: disabled

- systemd:
    name: firewalld
    state: stopped

- name: Permit afs3 traffic
  firewalld:
    port: 7000-7009/udp
    immediate: yes
    permanent: yes
    state: enabled
  when: False

- name: Check vice partitions
  include: vice-partition.yaml
  with_items: "{{ vicep.split(',') }}"
  when: vicep is defined

- name: Add epel yum repo
  yum:
    name: epel-release
    state: present
    update_cache: yes

- name: Add OpenAFS yum repo
  yum:
    name: "{{ openafs_yum_repo }}"
    state: present
    update_cache: yes

- name: Install OpenAFS server packages
  yum:
    state: present
    name:
      - openafs-server

- name: Update cell configuration
  template:
    src: "{{ item }}.j2"
    dest: "{{ openafs_path.afsconfdir }}/{{ item }}"
    mode: 0644
  with_items:
    - CellServDB
    - ThisCell
    - UserList
  # TODO: trigger on change

- name: Add service keys
  include: setkey-rxkad-krb5.yaml
  # TODO: old keyfile formats and rxkad.keytab

- name: Add local server directory
  file:
    state: directory
    path: "{{ openafs_path.afslocaldir }}"
    mode: 0700
    owner: root
    group: root

- name: Update local server configuration
  template:
    src: "{{ item }}.j2"
    dest: "{{ openafs_path.afslocaldir }}/{{ item }}"
    mode: 0644
    owner: root
    group: root
  with_items:
    - BosConfig.new
    - NetInfo
  # TODO: BosConfig.new is wiped on bosserver start, triggering a false change
  #       on subsequent runs.

- name: Start the OpenAFS servers
  systemd:
    name: openafs-server
    enabled: yes
    state: started

  # The root.afs volume must exist before non-dynroot clients can be started.
- include: root-afs-volume.yaml
  when: inventory_hostname == ansible_play_hosts[0]

  # The first admin user must be created on a machine with a service key.
- include: admin-user.yaml
  when: inventory_hostname == ansible_play_hosts[0]
