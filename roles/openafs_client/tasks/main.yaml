---

# TODO: REMOVE THIS
- name: disable selinux
  selinux:
    state: disabled

- systemd:
    name: firewalld
    state: stopped

- name: Permit afs3 traffic
  firewalld:
    port: 7000-7009/udp
    state: enabled
    immediate: yes
    permanent: yes
  when: False

- name: Add epel yum repo
  yum:
    name: epel-release
    state: present
    update_cache: yes

- name: Add OpenAFS yum repo
  yum:
    name: "{{ openafs_yum_repo }}"
    state: present
    update_cache: yes

- name: Check cache directory
  file:
    state: directory
    path: "{{ openafs_path.afscachedir }}"
    mode: 0700
    owner: root
    group: root

# TODO: how to select dkms or kmod install?
#- name: Install OpenAFS client packages
#  yum:
#    state: present
#    name:
#      - openafs
#      - openafs-client
#      - openafs-krb5
#      - dkms
#      - kernel-devel
#      - dkms-openafs

- name: Install OpenAFS client packages
  yum:
    state: present
    name:
      - openafs
      - openafs-client
      - openafs-krb5
      - kmod-openafs

- name: Update cell configuration
  template:
    src: "{{ item }}.j2"
    dest: "{{ openafs_path.viceetcdir }}/{{ item }}"
    mode: 0644
  with_items:
    - CellServDB.local
    - ThisCell
    - cacheinfo

- name: Start OpenAFS client
  service:
    state: started
    name: openafs-client
